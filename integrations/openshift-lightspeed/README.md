# OpenShift Lightspeed + Google Gemini Integration

## The Problem

OpenShift Lightspeed (OLS) is a powerful AI-powered coding assistant for OpenShift clusters, but it requires **OpenAI API keys** (expensive enterprise pricing).

We wanted Lightspeed powered by **Google Gemini** (free tier available) instead.

## The Solution

We deployed **LiteLLM** as a proxy layer inside the cluster that:
1. Accepts OpenAI-compatible requests from Lightspeed
2. Translates them to Google Gemini API calls
3. Returns responses in OpenAI format

**Result:** Lightspeed thinks it's talking to OpenAI, but it's actually using Gemini. ðŸš€

---

## Architecture

```
Lightspeed (OLS)
    â†“
    â”‚ (OpenAI API format)
    â†“
LiteLLM Proxy (Pod in cluster)
    â†“
    â”‚ (Translated to Google Gemini format)
    â†“
Google Generative AI API
    â†“
Gemini Response
    â†“
    â”‚ (Converted back to OpenAI format)
    â†“
Lightspeed
```

---

## Files in This Directory

- **`litellm.yaml`** â€” Kubernetes deployment for LiteLLM proxy (auto-generated by Molty)
- **`ols-config.yaml`** â€” OpenShift Lightspeed configuration (auto-generated by Molty)

### How These Were Created

When Chris asked: *"Can we connect Lightspeed to Gemini?"*, Molty didn't just give instructions â€” he **generated these YAMLs himself** based on the requirements:
1. Analyzed what Lightspeed expects (OpenAI API format)
2. Looked up LiteLLM proxy options
3. **Created the deployment & config files automatically**
4. Tested them against the cluster

This is the "Agent Advantage": You describe the goal, the Agent produces working code.

---

## Prerequisites

1. **OpenShift 4.x cluster** (tested on 4.19.22)
2. **Google Generative AI API Key** (get one at [ai.google.dev](https://ai.google.dev))
3. **kubectl/oc CLI access** with cluster-admin privileges
4. **A real user logged in** (not just `kube:admin`)
   - See "Identity Crisis" fix below

---

## Step 1: Deploy LiteLLM Proxy

The `litellm.yaml` file deploys a LiteLLM container that acts as the translator.

**What it does:**
- Creates a Deployment with one replica of the LiteLLM proxy
- Mounts your Google API key as a secret
- Exposes port 8000 (internal to cluster)

**Before applying:**
1. Create a secret with your Google API key:
   ```bash
   oc create secret generic litellm-keys \
     --from-literal=GOOGLE_API_KEY=<your-google-api-key> \
     -n openshift-lightspeed
   ```

2. Apply the deployment:
   ```bash
   oc apply -f litellm.yaml
   ```

3. Verify it's running:
   ```bash
   oc get pods -n openshift-lightspeed -l app=litellm-proxy
   ```

---

## Step 2: Configure OpenShift Lightspeed

The `ols-config.yaml` configures Lightspeed to use your LiteLLM proxy.

**Key parts:**
- `modelConfig.apiType: openai` â€” Tells OLS to use OpenAI API format
- `modelConfig.apiBaseURL: http://litellm-proxy:8000` â€” Points to your proxy
- `modelConfig.apiModel: gemini-2.5-pro` â€” Which Gemini model to use
- `introspectionEnabled: true` â€” Allows Lightspeed to read cluster logs (useful for troubleshooting)

**Apply it:**
```bash
oc apply -f ols-config.yaml
```

Verify:
```bash
oc get olsconfig -n openshift-lightspeed
oc describe olsconfig -n openshift-lightspeed
```

---

## Step 3: Create a Real User (Identity Crisis Fix)

Lightspeed needs to run as a **real Kubernetes user**, not `kube:admin`.

### Problem
If you just log in as `kube:admin` and ask Lightspeed to read cluster secrets/logs, it fails because OAuth/RBAC can't authorize a virtual principal.

### Solution: Create an HTPasswd User

1. **Generate an htpasswd file:**
   ```bash
   htpasswd -c -B -b htpasswd.txt my-admin <your-password>
   ```

2. **Create a Kubernetes Secret:**
   ```bash
   oc create secret generic htpass-secret \
     --from-file=htpasswd=htpasswd.txt \
     -n openshift-config
   ```

3. **Patch the OAuth cluster config:**
   ```bash
   oc patch oauth cluster --type='json' -p='[{"op": "add", "path": "/spec/identityProviders", "value": [{"name": "my_htpasswd_provider", "mappingMethod": "claim", "type": "HTPasswd", "htpasswd": {"fileData": {"name": "htpass-secret"}}}]}]'
   ```

4. **Grant the user cluster-admin:**
   ```bash
   oc adm policy add-cluster-role-to-user cluster-admin my-admin
   ```

5. **Log in as the new user:**
   ```bash
   oc login -u my-admin -p <your-password> https://<cluster-api-url>
   ```

6. **Now Lightspeed can read logs:**
   ```bash
   oc logs pod/<pod-name> -n <namespace>
   ```

---

## Step 4: Access Lightspeed

Once everything is configured and deployed:

1. Log into the OpenShift web console (as `my-admin`)
2. Navigate to **Lightspeed** (usually in the sidebar)
3. Ask Lightspeed a question about your cluster
4. It will use Gemini powerfully!

---

## Troubleshooting

### LiteLLM pod won't start
- Check the secret was created: `oc get secret litellm-keys -n openshift-lightspeed`
- Check logs: `oc logs -l app=litellm-proxy -n openshift-lightspeed`

### Lightspeed says "API error"
- Verify the OLSConfig is correct: `oc describe olsconfig -n openshift-lightspeed`
- Check if LiteLLM proxy is reachable: `oc exec -it <ols-pod> -- curl http://litellm-proxy:8000/health`

### "Cannot locate user"
- You might still be logged in as `kube:admin`. Log in as `my-admin` instead
- Check RBAC: `oc auth can-i get logs --as=my-admin --namespace=default`

### Google API rate limited
- See main [../../../JOURNAL.md](../../../JOURNAL.md) for fallback strategy
- You might need to switch to a different Gemini model or add a fallback in LiteLLM config

---

## Cost

- **Google Gemini API:** Free tier includes millions of tokens per month
- **OpenShift Lightspeed:** Included with OpenShift
- **LiteLLM:** Open-source, runs inside your cluster (no external cost)

**Total additional cost:** ~$0 (unless you exceed Google's free tier)

---

## References

- [OpenShift Lightspeed Documentation](https://docs.openshift.com/container-platform/latest/business_logic/lightspeed/about-ols.html)
- [LiteLLM Documentation](https://docs.litellm.ai/)
- [Google Generative AI API](https://ai.google.dev/)
- [OpenShift OAuth Configuration](https://docs.openshift.com/container-platform/latest/authentication/index.html)

---

**Last Updated:** 2026-02-03  
**Status:** âœ… Tested and working
